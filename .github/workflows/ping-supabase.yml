name: Keep Supabase Awake
on:
  schedule:
    - cron: "*/5 * * * *" # Every 5 minutes (more frequent to prevent free tier auto-pause)
  workflow_dispatch: # Allow manual trigger for testing
jobs:
  ping:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Keep Database Awake
        run: |
          echo "üîÑ Pinging Supabase database at $(date -u +"%Y-%m-%d %H:%M:%S UTC")..."

          # Retry logic: Try up to 3 times
          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            # Make actual database query via REST API to keep Postgres awake
            response=$(curl -s -w "\n%{http_code}" --max-time 30 \
              -H "apikey: $SUPABASE_ANON_KEY" \
              -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
              "$SUPABASE_URL/rest/v1/room_listings?select=id&limit=1")
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            echo "HTTP Status: $http_code"
            
            if [ "$http_code" = "200" ] || [ "$http_code" = "206" ]; then
              echo "‚úÖ Database query successful - Postgres is awake!"
              echo "Response count: $(echo "$body" | grep -o "id" | wc -l) records"
              exit 0
            else
              echo "‚ö†Ô∏è Unexpected status code: $http_code"
              echo "Response body: $body"
              
              if [ $attempt -lt $max_attempts ]; then
                echo "Retrying in 5 seconds..."
                sleep 5
              fi
            fi
            
            attempt=$((attempt + 1))
          done

          echo "‚ùå All attempts failed"
          exit 1
